# linux文件权限

## linux安全性

- 用户对系统中对象的访问权限取决于登陆时所用的系统。
- 用户权限是通过创建用户时分配的uid来跟踪的，uid唯一。

### /etc/passwd文件

- 存储用户名匹配的uid
- linux会为各种各样的功能创建不同的用户账户，这些不是真的账户，是系统上运行的各种服务进程访问资源用的特殊账户，称为**系统账户**。所有运行在后台的服务都需要用一个系统用户账户登陆到linux。
- linux为系统用户预留了500/1000以下的uid,有的服务需要使用特定的uid才能正常工作。普通用户创建账户时，从500/1000开始。
- 命令id可以查看用户自身uid,以及所属组的gid
- 该文件的数据结构为(用户名，密码，uid,gid,备注字段,HOME目录位置,默认shell)
  - 所有用户的密码字段都被设置为了x，用户密码保存在/etc/shadow中。
  - 被破坏后会导致用户无法登陆包括root。
  - 许多程序需要访问passwd获取用户信息

### /etc/shadow文件

- 只有root用户能访问该文件。
- 该文件的数据结构为(用户名,加密后的密码,自上次修改密码后过去的天数,多少天后才能改密码,多少天后必须改密码,密码过期前多少天提醒用户更改密码,密码过期后多少天禁用用户账户,用户账户被禁用的日期,预留字段)

### 新建用户

- useradd -D显示默认值,设置在/etc/default/useradd如sbin

|条目|解释|
|-|-|
|GROUP=100|新用户会被默认添加到gid为100的公共组|
|HOME=/home|新用户的HOME目录位于/home下|
|INACTIVE=-1|用户账户密码过期后不会被禁用|
|EXPIRE=|未设置过期日期|
|SHELL=/bin/bash|默认shell|
|SKEL=/etc/skel|默认将/ect/skel目录下的内容复制到用户的HOME目录下|
|CREATE_MAIL_SPOOL=yes|为该用户在mail目录下创建一个用于接收邮件的文件。|

- /etc/skel作为新用户的HOME目录的模板在ubuntu中默认包含bash的配置文件。
- 默认不会创建HOME目录

#### useradd的参数及描述

|参数|描述|
|-|-|
|-c comment|添加备注|
|-d home_dir|主目录名称，默认为登录名|
|-e expire_date|用YYYY-MM-DD的格式指定一个账户过期的日期|
|-f inactive_days|指定用户过期后多少天后禁用，0为过期立即禁用，-1为禁用该功能|
|-g initial_group|指定用户登录的gid或组名|
|-G group ...|指定用户除登录组之外所属的一个或多个附加组|
|-k|必须和-m一起使用，将/etc/skel目录的内容复制到用户的HOME目录|
|-m|创建目录的HOME目录|
|-M|不创建用户的HOME目录(默认创建时才使用)|
|-n|创建一个与用户登录名同名的新组|
|-r|创建系统账户|
|-p passwd|为用户指定默认密码，此处是加密后的密码，即shadow中的密码，不是铭文密码，需要使用passwd重新更改密码|
|-s shell|指定默认的登录shell|
|-u uid|指定uid|

#### useradd修改默认参数

- 加在-D参数后

|参数|描述|
|-|-|
|-b default_home|更改默认创建用户的HOME目录位置|
|-e expiration_date|更改默认的新账户的默认过期日期|
|-f inactive| 更改默认新用户密码过期后帐号被禁用的天数|
|-g group|更改默认的组名或组id|
|-s shell|更改默认登录shell|

### 删除用户

- userdel默认删除/ect/passwd和/etc/shadow文件中的用户信息，不会删除系统中属于该账户的文件。
- 加上-r会删除用户的HOME目录以及邮件目录，系统上仍可能存有一删除用户的其他文件。

### 修改用户

#### 用户账户修改工具

|命令名|描述|
|-|-|
|usermod|修改用户账户的字段，还可以指定主要组以及附加组的所属关系|
|passwd|修改已有用户的密码|
|chpasswd|从文件中读取登录名密码对，并更新密码|
|chage|修改密码的过期日期|
|chfn|修改用户账户的备注信息|
|chsh|修改用户账户的默认登录shell|

#### usermod

- 可以修改/etc/passwd文件中的大部分字段

##### usermod参数及描述

|参数|描述|
|-|-|
|-c comment|修改备注字段|
|-e expire_date|修改过期日期|
|-g group|修改默认的登录组|
|-G group|退出当前的附加组组，进入所选组|
|-a|追加，用于向用户的现有组成员身份中添加一个或多个新组，一般与-G连用|
|-l|修改用户账户的登录名|
|-L|锁定账户，使其无法登录|
|-p|修改账户的密码，密文密码不是明文密码|
|-U|解除锁定|

#### passwd和chpasswd

- 所有用户都能用passwd修改自己的密码，只有root用户可以改别人密码，-e参数可以强制用户下次登录时修改密码。passwd -u可以解除密码到期的账户禁用。
- chpasswd能够从标准输入自动读取登录名和密码对(用:分割)的列表，给密码加密然后为用户账户设置。可以将含有uid:passwd的文件重定向给该文件。

#### chsh,chfn和chage

- chsh用来快速修改默认的用户登录shell,chsh -s shell的绝对路径 user
- chfn提供了passwd中备注字段中存储信息的标准方法，会将用于finger命令的信息存进备注字段，而不是简单存储文本或将备注字段留空。finger可以查看用户信息。
- chage用来管理用户账户有效性，需要对每个值设置多个参数

##### chage的参数及描述

- 日期值可以选择YYYY-MM-DD或者从1970.1.1起到该日期天数的数值

|参数|描述|
|-|-|
|-d|设置上次修改密码到现在的天数|
|-E|设置密码过期的日期|
|-I|设置密码过期到锁定账户的天数|
|-m|设置修改密码之间最少要多少天|
|-W|修改密码过期前多少天出现提醒信息|

## linux组

- 组允许多个用户对系统中的对象共享一组共用的权限。

### /ect/group

- 该文件保存系统上用到的每个组的信息
- 该文件的数据结构(组名，组密码，gid,属于该组的用户列表)
  - 组密码允许非组内成员通过她临时成为该组成员
- 不能通过编辑来将用户添加一个组，需要使用usermod
- 列表中有的组没有列出用户，不是该组没有用户。用户在passwd中指定一个组作为默认组时，用户账户不会作为该组成员再出现在group文件中。

### 创建组

- 使用groupadd创建组，默认没有用户被分配到该组，添加成员时需使用usermod -G将用户添加到该组。
- 如果更改了当前已登录系统的账户所属的用户组，用户必须重新登陆才会生效。
- -g会替换默认组，-G不会影响默认组

### 修改组

- groupmod可以修改已有的组的gid(-g)或组名(-n)
- 修改组名时，gid和组成员不会变，只有组名改变。安全权限是基于gid的。

## 文件权限

- 文件的权限信息是记录在文件本身的元数据中的。元数据通常存储在文件系统中的 inode结构中。每个文件系统都有自己的 inode表，它存储了文件和目录的元数据信息，包括权限、所有者、所属组、文件大小、数据块的位置等。

### 文件权限符

- 文件和目录权限
  - 对象的类型
    - '-',文件
    - 'd',目录
    - 'l',链接
    - 'c',字符型设备
    - 'b',块设备
    - 'n',网络设备
  - 访问权限
    - 对象属主的权限
    - 对象属组的权限
    - 系统其他用户的权限
  - rwx
    - 如果对象是文件，则分别表示，读，写，执行
    - 如果对象是目录，分别表示是否可以查看目录内容(若已知文件路径仍可访问)，是否可以在该目录创建，删除和重命名文件或子目录，是否可以进入该目录，如果没有执行权限，无法根据路径访问文件。

### 默认文件权限

- umask命令用来设置所创建文件和目录的默认权限。
- umask返回值的结构
  - 第一位是粘着位。
  - 后三位表示文件或目录对应的umask八进制值。r-4，w-2,x-1。umask是掩码，会屏蔽掉不想授予该安全级别的权限。文件的默认权限为666，文件夹的默认权限为777。
- umask通常在/etc/profile中设置。有的设置在/etc/login.defs
- 可以使用umask 掩码，重新设置umask的值

## 改变安全性设置

### 改变权限

- chmod用来改变文件和目录的安全性设置。
  - 可以直接使用八进制模式设置权限
  - 使用-R可以让权限的改变递归地作用到文件以及子目录。
  - [u/g/o/a] [+/-/=] [r/w/x/X/s/t/u/g/o]
    - 第一组定义权限作用对象
      - u表示用户，g表示组，o表示其他，a表示上述所有
    - 第二组表示操作
      - +表示在现有权限上增加权限，-表示在现有权限上移除权限，=表示将权限设置成后面的值
    - 第三组表示作用到设置上的权限。
      - X,如果对象是目录或者其他已有执行权限，赋予执行权限
      - s,运行时重新设置uid或gid
      - t,保留文件或目录
      - u,设置文件数组权限
      - g,设置文件属组权限
      - o,设置其他用户权限

### 改变所属关系

- 使用chown可以改变文件的属主，chgrp可以改变文件的默认属组
  - -R可以递配合通配符递归地改变子目录和文件的所属关系，-h可以改变该文件的所有符号链接的所属关系。
  - chown 新属主 文件，改变文件的属主
  - chown 新属主.新属组 文件，可以同时改变文件的属主和属组
  - chown .新属组 文件，改变文件的属组
  - chown 新属主. 文件，采用和用户登录名匹配的组名。
  - chgrp 新属组 文件,文件，属主还必须是新组的成员。
- 只有root用户可以改变文件的属主，文件的属主可以改变文件的属组，前提是属主必须是原属组和目标属组的成员。

## 共享文件

- 每个文件和目录存储了3个额外的信息位。
  - 设置用户id(SUID):文件被用户使用时，程序会以文件属主的权限运行。
  - 设置组id(SGID):对文件来说，程序会以文件属组的权限运行，对目录来说，目录中创建的新文件会以目录的默认属组作为默认属组。
  - 粘着位:进程结束后文件还驻留在内存中。
- 启用SGID后，可以强制在一个共享目录下创建的新文件都属于该目录的属组，这个组也就成了每个用户的属组。
- 使用chmod设置SUID,SGID和粘着位
  - 八进制权限(SUID:4,SGID:2,粘着位:1)
  - u+s启用SUID，g+s启用SGID，+t启用粘着位
- 启用SUID后意味着所有用户都可以编辑，启用SGID意味着新建文件和父文件相同组权限，只要属于共享组就可以访问。
- 创建步骤
  1. 创建共享目录
  2. 创建共享组
  3. 启用SGID
